# regression testing

The purpose of the [docker-compose.yml](docker-compose.yml) file is to test the successful launch of different vMX versions. The script [check.sh](check.sh) monitors the progress of all launched vMX instances until all of them report operational FPC status (via CLI command 'show chassis fpc') or report FAILURE if it takes more than 10 minutes to complete.

New Junos vMX versions can be added to the [docker-compose.yml](docker-compose.yml) file, together with a unique Junos configuration file. 

Before launching the regression test, make sure the compute host has enough Hugepages configured (1GB per vMX instance). The required Junos vMX versions can be found via grep:

```shell
$ grep qcow2 regression/docker-compose.yml
      - IMAGE=junos-vmx-x86-64-18.2R1.9.qcow2
      - IMAGE=junos-vmx-x86-64-18.1R1.9.qcow2
      - IMAGE=junos-vmx-x86-64-17.4R1.16.qcow2
      - IMAGE=junos-vmx-x86-64-17.3R2.10.qcow2
      - IMAGE=junos-vmx-x86-64-17.3R1.10.qcow2
      - IMAGE=junos-vmx-x86-64-18.1R2.5.qcow2
      - IMAGE=junos-vmx-x86-64-18.3R1.9.qcow2
      - IMAGE=junos-vmx-x86-64-18.4R1.8.qcow2
```

Then launch the regression test from the main repository directory, where the vMX qcow2 images are located:

```
$ pwd
/home/lab/OpenJNPR-Container-vMX
$ make regress
docker-compose -f regression/docker-compose.yml up -d
Creating network "regression_mgmt" with the default driver
Creating network "regression_net-a" with the default driver
Creating network "regression_net-b" with the default driver
Creating network "regression_net-c" with the default driver
Creating regression_vmx4_1 ... done
Creating regression_vmx7_1 ... done
Creating regression_vmx6_1 ... done
Creating regression_vmx1_1 ... done
Creating regression_vmx5_1 ... done
Creating regression_vmx2_1 ... done
Creating regression_vmx3_1 ... done
Creating regression_vmx8_1 ... done
regression/check.sh
wait for fpc0 up in 8 instances (0 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (26 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (53 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (80 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (106 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (133 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (159 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (186 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (209 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) ...
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (235 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) ...
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) ...
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) ...
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) ...
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) ...
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) fpc0 up
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (250 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) fpc0 up
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) fpc0 up
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) fpc0 up
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) fpc0 up
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) fpc0 up
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) fpc0 up
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) ...
wait for fpc0 up in 8 instances (264 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) fpc0 up
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) fpc0 up
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) ...
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) fpc0 up
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) fpc0 up
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) fpc0 up
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) fpc0 up
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) fpc0 up
wait for fpc0 up in 8 instances (309 seconds)...
vMX regression_vmx8_1 (v4:172.26.0.5 v6:2001:db8:1234:1234::5) fpc0 up
vMX regression_vmx2_1 (v4:172.26.0.6 v6:2001:db8:1234:1234::6) fpc0 up
vMX regression_vmx3_1 (v4:172.26.0.8 v6:2001:db8:1234:1234::8) fpc0 up
vMX regression_vmx5_1 (v4:172.26.0.4 v6:2001:db8:1234:1234::4) fpc0 up
vMX regression_vmx7_1 (v4:172.26.0.7 v6:2001:db8:1234:1234::7) fpc0 up
vMX regression_vmx1_1 (v4:172.26.0.9 v6:2001:db8:1234:1234::9) fpc0 up
vMX regression_vmx6_1 (v4:172.26.0.3 v6:2001:db8:1234:1234::3) fpc0 up
vMX regression_vmx4_1 (v4:172.26.0.2 v6:2001:db8:1234:1234::2) fpc0 up
8 instances up in 312 seconds
SUCCESS
```

Deleting all vMX instances:

```
$ make down
docker-compose down
Removing network openjnpr-container-vmx_mgmt
WARNING: Network openjnpr-container-vmx_mgmt not found.
Removing network openjnpr-container-vmx_net-a
WARNING: Network openjnpr-container-vmx_net-a not found.
Removing network openjnpr-container-vmx_net-b
WARNING: Network openjnpr-container-vmx_net-b not found.
Removing network openjnpr-container-vmx_net-c
WARNING: Network openjnpr-container-vmx_net-c not found.
docker-compose -f regression/docker-compose.yml down
Stopping regression_vmx4_1 ... done
Stopping regression_vmx8_1 ... done
Stopping regression_vmx2_1 ... done
Stopping regression_vmx6_1 ... done
Stopping regression_vmx7_1 ... done
Stopping regression_vmx3_1 ... done
Stopping regression_vmx1_1 ... done
Stopping regression_vmx5_1 ... done
Removing regression_vmx4_1 ... done
Removing regression_vmx8_1 ... done
Removing regression_vmx2_1 ... done
Removing regression_vmx6_1 ... done
Removing regression_vmx7_1 ... done
Removing regression_vmx3_1 ... done
Removing regression_vmx1_1 ... done
Removing regression_vmx5_1 ... done
Removing network regression_mgmt
Removing network regression_net-a
Removing network regression_net-b
Removing network regression_net-c
removing images/p1.qcow2
```
